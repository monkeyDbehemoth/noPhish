{% extends "base.html" %}

{% block title %}Emails - noPhish{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-envelope"></i> Email Logs</h2>
</div>

<div class="card table-card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <select name="filter" class="form-select">
                    <option value="all" {{ 'selected' if filter_type == 'all' else '' }}>All Emails</option>
                    <option value="phishing" {{ 'selected' if filter_type == 'phishing' else '' }}>Phishing Only</option>
                    <option value="clean" {{ 'selected' if filter_type == 'clean' else '' }}>Clean Only</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="text" name="search" class="form-control" placeholder="Search by sender or subject..." value="{{ search }}">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Search
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card table-card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Sender</th>
                        <th>Subject</th>
                        <th>Score</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for email in emails.items %}
                    <tr>
                        <td>{{ email.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if email.is_phishing %}
                            <span class="badge badge-phishing">Phishing</span>
                            {% else %}
                            <span class="badge badge-clean">Clean</span>
                            {% endif %}
                        </td>
                        <td>{{ email.sender[:40] }}{{ '...' if email.sender|length > 40 else '' }}</td>
                        <td>{{ email.subject[:40] }}{{ '...' if email.subject|length > 40 else '' }}</td>
                        <td>
                            {% if email.is_phishing %}
                            <span class="badge bg-danger">{{ email.total_score }}/10</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ email.total_score }}/10</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('email_detail', email_id=email.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                            <form method="POST" action="{{ url_for('delete_email', email_id=email.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this email log?')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">No emails found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if emails.pages > 1 %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if emails.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('emails', page=emails.prev_num, filter=filter_type, search=search) }}">Previous</a>
        </li>
        {% endif %}
        
        {% for page_num in emails.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
            <li class="page-item {{ 'active' if page_num == emails.page else '' }}">
                <a class="page-link" href="{{ url_for('emails', page=page_num, filter=filter_type, search=search) }}">{{ page_num }}</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endfor %}
        
        {% if emails.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('emails', page=emails.next_num, filter=filter_type, search=search) }}">Next</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}
